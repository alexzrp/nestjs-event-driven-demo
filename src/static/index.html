<html lang='en'>
<head>
  <title>SSE Demo</title>
  <style>
      @import url('https://fonts.googleapis.com/css?family=Roboto');

      body {
          font-family: Roboto, sans-serif;
      }

      #chart {
          max-width: 640px;
          margin: 35px auto;
      }

  </style>
</head>
<body>
<div id='chart'></div>
<script src='https://cdn.jsdelivr.net/npm/apexcharts'></script>
<script type='text/javascript'>
  let series = [];
  const options = {
    chart: {
      height: 500,
      type: 'line',
      animations: {
        enabled: false,
        easing: 'linear',
        dynamicAnimation: {
          speed: 1000,
        },
      },
      toolbar: {
        show: false,
      },
      zoom: {
        enabled: false,
      },
    },
    dataLabels: {
      enabled: false,
    },
    series,
    stroke: {
      curve: 'smooth',
    },
    markers: {
      size: 0,
    },
    title: {
      text: 'SSE Demo',
    },
    noData: {
      text: 'Loading...',
    },
    xaxis: {
      type: 'datetime',
    },
    legend: {
      show: false,
    },
  };

  const chart = new ApexCharts(
    document.querySelector('#chart'),
    options,
  );

  chart.render();

  const eventSource = new EventSource('/api/notification/sse');

  eventSource.onmessage = (message) => {
    console.log(message);
    const data = JSON.parse(message.data);
    data.forEach(d => {
      let serie = series.find(s => s.name===d.queue);

      if (!serie) {
        serie = {
          name: d.queue,
          data: [],
        };
      }
      serie.data = [
        ...serie.data.slice(-10),
        { x: new Date(), y: d.jobs_waiting },
      ];

      series = [...series.filter(s => s.name!==serie.name), serie];

    });
    chart.updateSeries(series);

  };
</script>
</body>
</html>

